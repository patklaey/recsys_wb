<?php

/**
 * Core module for the recommender system workbench
 */
 
/** 
 * Define max user ID as the maximum user ID from the book and movie database. 
 * The logged in user will add it's user id to the max user id constant to get a
 * unique user id in the rating tables
 */ 
define('MAX_USER_ID',278858);
define('MOVIE_DB_TRAIN','Movie_Rating_demo_train');
define('BOOK_DB_TRAIN','Book_Rating_demo_train');
define('MOVIE_DB_TEST','Movie_Rating_demo_test');
define('BOOK_DB_TEST','Book_Rating_demo_test');

// Variables
define('user_id',$GLOBALS['user']->uid + MAX_USER_ID);

// Load the necessary php files
require_once 'util.php';
require_once 'recommendations.php';
require_once 'forms/forms_view.php';
require_once 'forms/forms_submit.php';
require_once 'statistics.php';
require_once 'php-tail/PHPTail.php';
require_once 'evaluation.php';
require_once 'CF.php';
require_once 'CB.php';
require_once 'evaluation_explain.php';

/**
 * Implements hook_menu()
 */
function recsys_wb_menu() {
  $items['myratings'] = array(
    'title' => 'My Ratings', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_myratings',
    'access arguments' => array('access content'),
    'weight' => 2,
  );
  $items['myrecommendations'] = array(
    'title' => 'My Recommendations', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_myrecommendations',
    'access arguments' => array('access content'),
    'weight' => 3,
  );
  $items['content'] = array(
    'title' => 'Content', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_content',
    'access arguments' => array('access content'),
    'weight' => 1,
  );
  $items['content/questions'] = array(
    'title' => 'Questions', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_so_questions',
    'access arguments' => array('access content'),
    'weight' => 3,
  );
  $items['content/books'] = array(
    'title' => 'Books', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_books',
    'access arguments' => array('access content'),
    'weight' => 1,
  );
  $items['content/movies'] = array(
    'title' => 'Movies', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_movies',
    'access arguments' => array('access content'),
    'weight' => 2,
  );
  $items['statistics'] = array(
    'title' => 'Statistics', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_statistics',
    'access arguments' => array('access content'),
    'weight' => 4,
  );
  $items['statistics/evaluation'] = array(
    'title' => 'Show evaluations', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_evaluation',
    'access arguments' => array('access content'),
    'weight' => 1,
  );
  $items['statistics/runstatistics'] = array(
    'title' => 'Runtime statistics', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_display_stats',
    'access arguments' => array('access content'),
    'weight' => 2,
  );
  $items['learn'] = array(
    'title' => 'Learn', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_explanation',
    'access arguments' => array('access content'),
    'weight' => 5,
  );
  $items['learn/cf'] = array(
    'title' => 'Collaborative filtering', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_explanation_cf',
    'access arguments' => array('access content'),
  );
  $items['learn/cb'] = array(
    'title' => 'Content based filtering', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_explanation_cb',
    'access arguments' => array('access content'),
  );
  $items['learn/evaluation'] = array(
    'title' => 'Evaluating recommender systems', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_explanation_evaluation',
    'access arguments' => array('access content'),
  );
  $items['aboutthis'] = array(
    'title' => 'About', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_about',
    'access arguments' => array('access content'),
    'weight' => 6,
  );
  $items['administrate'] = array(
    'title' => 'Admin', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_admin_page',
    'access arguments' => array('administration'),
    'weight' => 7,
  );
  $items['administrate/evaluatealgorithms'] = array(
    'title' => 'Evaluate Algorithms', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_evaluate_algorithms',
    'access arguments' => array('administration'),
  );
  $items['administrate/runrecommender'] = array(
    'title' => 'Run Recommender',
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_run_recommender',
    'access arguments' => array('administration'),  
  );
  $items['administrate/contentsimilarity'] = array(
    'title' => 'Content Similarity', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_content_similarity',
    'access arguments' => array('administration'),
  );
  $items['administrate/runcontentrecommender'] = array(
    'title' => 'Run Content Recommender', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_run_content_recommender',
    'access arguments' => array('administration'),
  );  
  $items['tail'] = array(
    'title' => 'Tail',
    'type' => MENU_CALLBACK,
    'page callback' => 'recsys_wb_tail',
    'access arguments' => array('access content'),
  );
  $items['runevaluations'] = array(
    'title' => 'Run Evaluations',
    'type' => MENU_CALLBACK,
    'page callback' => 'recsys_wb_run_evaluations',
    'access arguments' => array('access content'),
  );
  return $items;
}

/**
 * Custom page which displays all the ratings of the currently logged in user
 */
function recsys_wb_myratings() {
  // Prepare the return string
  $return_string = "<strong>Books</strong>";
  
  // Get all the users rating from the database
  $query = db_select(BOOK_DB_TRAIN, 'ratings');
  $query->join(
    'field_data_field_book_id',
    'book_id',
    'ratings.bookid = book_id.field_book_id_value'
  );
  $query->join( 
    'field_data_field_dataset',
    'dataset',
    'dataset.entity_id = book_id.entity_id'
  );
  $query->join('node','node','node.nid = book_id.entity_id');
  $query->fields('node',array('title','nid'));
  $query->fields('ratings',array('bookid','userid','rating'));
  $query->condition('ratings.userid',user_id);
  $query->condition('dataset.field_dataset_value','99');
  $results = $query->execute();
  
  // Prepeare the tables headers and rows
  $header = array( t('User ID'), t('Book'), t('Rating') );
  $rows = array();
  
  // Check if there are already some ratings
  if( $results->rowCount() == 0 ) {
    $return_string .= "<strong>You haven't rated any books yet</strong></br>";
    // Add the link to the rating page
    $return_string .= "<p>You can rate books " . l('here','books') . "</p>";
  }
  else {
    
    // Loop through the results of the DB query and fill in the tables rows
    foreach ($results AS $result)
    {
      $rows[] = array(
        $result->userid,
        l($result->title, 'node/' . $result->nid),
        $result->rating,
      );
    }
    
    // Add the table to the result string
    $return_string .= theme('table', 
                            array('header' => $header, 'rows' => $rows) );
    // Add a link to run recommendation algorithms
    $return_string .= l('Calculate recommendations','runrecommender');
  }

  // Add the Movie section
  $return_string .= "<br/><br/><strong>Movies</strong>";
  
  // Get all the users rating from the database
  $query = db_select(MOVIE_DB_TRAIN, 'ratings');
  $query->join(
    'field_data_field_movie_id',
    'movie_id',
    'ratings.movieid = movie_id.field_movie_id_value'
  );
  $query->join('node','node','node.nid = movie_id.entity_id');
  $query->fields('node',array('title','nid'));
  $query->fields('ratings',array('movieid','userid','rating'));
  $query->condition('ratings.userid',user_id);
  $results = $query->execute();
  
  // Prepare the tables headers and rows
  $header = array( t('User ID'), t('Movie'), t('Rating') );
  $rows = array();
  
  // Check if there are already some ratings
  if( $results->rowCount() == 0 ) {
    $return_string .= "<strong>You haven't rated any movies yet</strong></br>";
    // Add the link to the rating page
    $return_string .= "<p>You can rate movies " . l('here','movies') . "</p>";
  }
  else {
    
    // Loop through the results of the DB query and fill in the tables rows
    foreach ($results AS $result)
    {
      $rows[] = array(
        $result->userid,
        l( $result->title, 'node/' . $result->nid),
        $result->rating,
      );
    }
    
    // Add the table to the result string
    $return_string .= theme('table', 
                            array('header' => $header, 'rows' => $rows) );
    // Add a link to run recommendation algorithms
    $return_string .= l('Calculate recommendations','runrecommender');
  }
  
  // Return the HTML string
  return $return_string;
}

/**
 * Custom page which displays all the recommendations of the currently logged
 * in user
 */
function recsys_wb_myrecommendations() {
  return showRecommendations();
}

/**
 * Custom page which displays all the recommendations of the currently logged
 * in user
 */
function recsys_wb_evaluation() {
  return showEvaluation();
}

/**
 * 
 */
function recsys_wb_run_evaluations() {
  runEvaluations();
}

/**
 * 
 */
function recsys_wb_evaluate_algorithms() {
  return drupal_get_form('recsys_wb_evaluate_algorithms_form');
}
 
/**
 * Implements hook_block_info
 */
function recsys_wb_block_info() {
  $blocks['book_rating'] = array(
    'info' => t('Recsys workbench book rating'),
  );
  $blocks['movie_rating'] = array(
    'info' => t('Recsys workbench movie rating'),
  );
  $blocks['run_content_recommender'] = array(
    'info' => t('Recsys workbench run content recommender'),
  );
  $blocks['create_tfidf_vectors'] = array(
    'info' => t('Recsys workbench create TFIDF vectors'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view
 */
function recsys_wb_block_view($delta = '')
{
  $block = array();

  // Get the node
  $node = menu_get_object();

  switch ($delta) {
    case 'book_rating':
      $block['subject'] = t('Rate this book');
      
      // Check if the user has already rated this book, so query the rating for
      // this book from this user
      $book_id = field_get_items("node", $node, "field_book_id");
      $book_id = $book_id[0]["value"];
      $results = db_query("Select * from {" . BOOK_DB_TRAIN . "} where UserID ="
        .":user AND BookID = :book", 
        array(':user' => user_id, ':book' => $book_id) );
      
      if ( $results->rowCount() == 0 ) {
        $block['content'] = drupal_get_form('recsys_wb_book_rating_form');
      }
      else {
        $block['content'] = "You have already rated this book!";
      }

      break;

    case 'movie_rating':
      $block['subject'] = t('Rate this movie');
      
      // Check if the user has already rated this book, so query the rating for
      // this book from this user
      $movie_id = field_get_items("node", $node, "field_movie_id");
      $movie_id = $movie_id[0]["value"];
      $results = db_query("Select * from {" . MOVIE_DB_TRAIN . "} where UserID="
        .":user AND MovieID = :movie", 
        array(':user' => user_id, ':movie' => $movie_id) );
      
      if ( $results->rowCount() == 0 ) {
        $block['content'] = drupal_get_form('recsys_wb_movie_rating_form');
      }
      else {
        $block['content'] = "You have already rated this movie!";
      }
      
    case 'run_content_recommender':
      $block['subject'] = t('Run content recommender');
      $block['content'] = drupal_get_form(
        'recsys_wb_run_content_recommender_form'
      );
      break;

    case 'create_tfidf_vectors':
      $block['subject'] = t('Create TFIDF vectors');
      $block['content'] = drupal_get_form(
        'recsys_wb_create_tfidf_vectors_form'
      );
      break;
      
    default:
        break;
  }
    
  return $block;
}

/**
 * Custom page which displays all book of the demo section
 */
function recsys_wb_books() {
  // Get all movies form the database
  $query = db_select('field_data_field_dataset', 'dataset')
    ->extend('PagerDefault')->limit(100);
  $query->join('node', 'node', 'dataset.entity_id = node.nid');
  $query->fields('dataset',array('entity_id'));
  $query->fields('node',array('title'));
  $query->orderBy('node.title');
  $query->condition('dataset.field_dataset_value',99);

  $results = $query->execute();
  
  $header = array( t('Book'));
  $rows = array();
  
  foreach ($results AS $result)
  {
    $rows[] = array(
      l($result->title,'node/' . $result->entity_id)
    );
  }
  
  $output =  theme('table', array('header' => $header, 'rows' => $rows) );
  return $output . theme('pager');
}

/**
 * Custom page which displays all movies of the demo section
 */
function recsys_wb_movies() {
  // Get all movies form the database
  $query = db_select('field_data_field_year', 'year')
    ->extend('PagerDefault')->limit(100);
  $query->join('node', 'node', 'year.entity_id = node.nid');
  $query->fields('year',array('entity_id'));
  $query->fields('node',array('title'));
  $query->orderBy('node.title');
  $query->condition('year.field_year_value',2008);
  $results = $query->execute();
  
  $header = array( t('Node ID'));
  $rows = array();
  
  foreach ($results AS $result)
    {
      $id = $result->entity_id;
      $rows[] = array(
        l($result->title,'node/' . $id)
      );
    }

  $output =  theme('table', array('header' => $header, 'rows' => $rows) );
  return $output . theme('pager');
}

/**
 * Custom page to run recommenders
 */
function recsys_wb_run_recommender() {
  return drupal_get_form('recsys_wb_run_recommender_form');
}

/**
 * Custom page to run content recommender
 */
function recsys_wb_run_content_recommender() {
  $content = "Create TFIDF vectors: ";
  $content .= drupal_render(
    drupal_get_form('recsys_wb_create_tfidf_vectors_form')
  );
  $content .= "<br/>Run content similarity algorithm: ";
  $content .= drupal_render(
    drupal_get_form('recsys_wb_run_content_recommender_form')
  );
  
  return $content;
}

/** 
 * Follow the log file of the different algorithm processes
 */
function recsys_wb_tail() {
  /**
   * Initilize a new instance of PHPTail
   * @var PHPTail
   */
  // Get the UUID of the log file
  $uuid = $_GET['uuid'];
  // Get the log directory
  $log_dir = DRUPAL_ROOT . DIRECTORY_SEPARATOR 
    . drupal_get_path("module","recsys_wb") . DIRECTORY_SEPARATOR . "log";
  // Get the according file
  $file = $log_dir . DIRECTORY_SEPARATOR . $uuid . ".log";
  // Check if the file exists, if not return some error message
  if ( ! file_exists ( $file ) )
    return "Invalid file: " . $file;
  $tail = new PHPTail($file);
  // Set the origin to 311 bytes to not show the user which configuration file
  // we are using
  $tail = $tail->setOrigin(311);

  /**
   * We're getting an AJAX call
   */
  if(isset($_GET['ajax']))  {
    echo $tail->getNewLines($_GET['lastsize'], $_GET['grep'], $_GET['invert']);
    die();
  }
  /**
   * Regular GET/POST call, print out the GUI
   */
  $tail->generateGUI();
}

/**
 * 
 */
function recsys_wb_explanation () {
  $cf = l("Collaborative filtering",'learn/cf');
  $cb = l("Content based filtering",'learn/cb');
  $evaluation = l("Evaluation metrics",'learn/evaluation');
  
  $return_string = "There is a lot where you can learn about recommender ";
  $return_string .= "systems.
<ul>
  <li>$cf<br/>
    Learn about collaborative filtering. What is the idea behind, what
    are the different similarity methods and see some examples how to calculate
    them. 
  </li>
  <li>$cb<br/>
    Learn about content filtering. What is the idea behind, what
    are the calculations to represent a document in a form which can be 
    mathematically compared to other documents etc. 
  </li>
  <li>$evaluation<br/>
    Learn about evaluation. What is the idea behind, what are the different 
    metrics etc.
  </li>
</ul>
";
  
  return $return_string;
}

/**
 * Explain collaborative filtering
 */
function recsys_wb_explanation_cf() {
  $algorithm_name = null;
  $explain = "";
  $marking = MARK_USER2USER;
  
  // Check if the GET[algorithm] method is set
  if ( isset($_GET['algorithm']) )
    $algorithm_name = getRecommenderAppName( $_GET['algorithm'] );
  
  if ( $algorithm_name != null ) {
    $explain = "<strong>Explanation for " 
      . getRecommenderAppTitle( $_GET['algorithm'] ) . "</strong>";
  }
  else {
          
    $checked_user2user = 'checked';
    $checked_item2item = '';
    
    drupal_add_css(
      drupal_get_path('module', 'recsys_wb') . '/css/radio-button.css'
    );
    
    // Check if a POST request was sent if yes check which type it is
    if ( isset($_POST['explain']) ) {
      if ( $_POST['explain'] == 'user2user') {
        $checked_user2user = 'checked';
        $checked_item2item = '';
        $marking = MARK_USER2USER;
      }
      
      if ( $_POST['explain'] == 'item2item') {
        $checked_user2user = '';
        $checked_item2item = 'checked';
        $marking = MARK_ITEM2ITEM;
      }
    }
    
    $explain .= "<strong>Similarity examples:</strong>";
    $explain .= "
<div class='toggle-btn-grp joint-toggle'>
<form method='POST'>
  <label class='toggle-btn'>
    <input onChange='this.form.submit();' $checked_user2user type='radio' value='user2user' name='explain'/>
    User-User
  </label>
  <label class='toggle-btn'>
    <input onChange='this.form.submit();' $checked_item2item type='radio' value='item2item' name='explain'/>
    Item-Item
  </label>
</form>
</div>";

    // Add the table of contents
    $explain .= recsys_wb_explanation_cf_table_of_contents();  
    
  }

  // Explain the basics of collaborative filtering
  $explain .= "<a href='#' name='cf'></a>";
  $explain .= recsys_wb_explain_cf();
  
  $explain_user2user = preg_match("/_u2u_/", $algorithm_name);
  $explain_item2item = preg_match("/_i2i_/", $algorithm_name);
  $explain_cosine = preg_match("/_cosine/", $algorithm_name);
  $explain_euclidean = preg_match("/_euclidean/", $algorithm_name);
  $explain_pearson = preg_match("/_pearson/", $algorithm_name);
  
  $explain .= "<a href='#' name='algorithm'></a>";
  if( $explain_user2user || $algorithm_name == null ){
    $explain .= "<a href='#' name='user2user'></a>"; 
    $explain .= recsys_wb_explain_user2user();
  }
  
  if ( $explain_item2item )
  {
    $explain .= "<a href='#' name='item2item'></a>";
    $explain .= recsys_wb_explain_item2item();
    $marking = MARK_ITEM2ITEM;
  }
  else{
    if ( $algorithm_name == null ) {
      $explain .= "<a href='#' name='item2item'></a>";
      $explain .= recsys_wb_explain_item2item();
    }
  }

  $explain .= "<a href='#' name='similarity'></a>";
  if ( $explain_cosine || $algorithm_name == null ) {
    $explain .= "<a href='#' name='cosine'></a>"; 
    $explain .= recsys_wb_explain_cosine($marking);
  }
  
  if ( $explain_pearson || $algorithm_name == null ){
    $explain .= "<a href='#' name='pearson'></a>"; 
    $explain .= recsys_wb_explain_pearson($marking);
  }
  
  if ( $explain_euclidean || $algorithm_name == null ){
    $explain .= "<a href='#' name='euclidean'></a>"; 
    $explain .= recsys_wb_explain_euclidean($marking);
  }
  
  return $explain;
}

/**
 * Table of contents for the explanation section
 */
function recsys_wb_explanation_cf_table_of_contents() {
  $table_of_contents = "
<ul style='list-style-type:none'>
  <li><strong><a href='#cf'>Collaborative filtering</a></strong></li>
  <li><strong><a href='#algorithm'>Algorithm type</a></strong></li>
  <ul style='list-style-type:none'>
    <li><a href='#user2user'>User-User Recommendation</a></li>
    <li><a href='#item2item'>Item-Item Recommendation</a></li>
  </ul>
  <li><strong><a href='#similarity'>Similarity methods</a></strong></li>
  <ul style='list-style-type:none'>
    <li><a href='#cosine'>Cosine similarity</a></li>
    <li><a href='#pearson'>Pearson similarity</a></li>
    <li><a href='#euclidean'>Euclidean similarity</a></li>
  </ul>
</ul>
";
  return $table_of_contents;
}

/**
 * Explain content based filtering
 */
function recsys_wb_explanation_cb() {
  $explanation = recsys_wb_explain_cb();
  $explanation .= recsys_wb_explain_tfidf();
  $explanation .= recsys_wb_explain_content_similarity();
  return $explanation;
}

/**
 * Explain the evaluation methods
 */
function recsys_wb_explanation_evaluation() {
  $metric_name = null;
  
  // Check if the GET[algorithm] method is set
  if ( isset($_GET['metric']) )
    $metric_name = $_GET['metric'];
    
  $explanation = recsys_wb_explain_evaluation();
  
  if ( $metric_name == 'mae' || $metric_name == null )
    $explanation .= recsys_wb_explain_mae();
  
  if ( $metric_name == 'rmse' || $metric_name == null )
    $explanation .= recsys_wb_explain_rmse();
    
  if ( $metric_name == 'mrr' || $metric_name == null )
  $explanation .= recsys_wb_explain_mrr();
  
  if ( $metric_name == 'ndcg' || $metric_name == null )
    $explanation .= recsys_wb_explain_ndgc();

  return $explanation;
  
}
 
/**
 * 
 */
function recsys_wb_content() {
  $books = l("Books",'content/books');
  $movies = l("Movies",'content/movies');
  $questions = l("Stackoverflow questions",'content/questions');
  
  $return_string = "There are 3 different content types which you can browse: ";
  $return_string .= "
<ul>
  <li>$books<br/>Some description</li>
  <li>$movies<br/>Some description</li>
  <li>$questions<br/>Some description</li>
</ul>
";
  
  return $return_string;
}

/**
 * 
 */
function recsys_wb_statistics() {
  $evaluation = l("Algorithm Evaluation",'statistics/evaluation');
  $stats = l("Run Statistics",'statistics/runstatistics');
  
  $return_string = "There are 2 different types of statistics";
  $return_string .= "
<ul>
  <li>$evaluation<br/>See detailed evaluation about the different recommender
    algorithms. 
  </li>
  <li>$stats<br/>See statistics of the recommender algorithm run like number of
    users, number of items etc.
  </li>
</ul>
";
  
  return $return_string;
}


/**
 * 
 */
function recsys_wb_so_questions() {
  // Get all movies form the database
  $query = db_select('field_data_field_question_dataset', 'dataset');
  $query->join('node', 'node', 'dataset.entity_id = node.nid');
  $query->fields('dataset',array('entity_id'));
  $query->fields('node',array('title'));
  $query->orderBy('node.title');
  $query->condition('dataset.field_question_dataset_value','demo');

  $results = $query->execute();
  
  $header = array( t('Question'));
  $rows = array();
  
  foreach ($results AS $result)
  {
    $rows[] = array(
      l($result->title,'node/' . $result->entity_id)
    );
  }
  
  $output =  theme('table', array('header' => $header, 'rows' => $rows) );
  return $output;
}

/**
 * A page which displays content similarity
 */
function recsys_wb_content_similarity() {
  $query = db_select('recsys_wb_content_similarity', 'sim');
  $query->fields('sim',array(
    'source_entity_id',
    'target_entity_id',
    'similarity')
  );
  $query->orderBy('sim.similarity','DESC');
  $query->condition('sim.app_id',1);
  $query->range(0,50);
  $results = $query->execute();
  
  $header = array( t('Source'), t('Target'), t('Score'));
  $rows = array();
  
  foreach ($results AS $result)
    {
      $rows[] = array(
        l($result->source_entity_id,'node/' . $result->source_entity_id),
        l($result->target_entity_id,'node/' . $result->target_entity_id),
        $result->similarity,
      );
    }

  $output =  theme('table', array('header' => $header, 'rows' => $rows) );
  return $output;
}



/**
 * The admin page
 */
function recsys_wb_admin_page() {
  return "Hello";
}

/**
 * The about section
 */
function recsys_wb_about() {
  $andreas_meier = l(
    "Prof. Dr. Andreas Meier", 
    "http://diuf.unifr.ch/main/is/members/andreas-meier",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  
  $luis_teran = l(
    "Dr. Luis Teran",
    "http://diuf.unifr.ch/main/is/members/luis-teran",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  
  $is_group = l(
    "Information Systems Research Group",
    "http://diuf.unifr.ch/main/is/",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  
  $unifr = l(
    "University of Freiburg (CH)",
    "http://www.unifr.ch/home/welcomeE.php",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  $return = "This workbench the practical part of my master thesis \"A Workbench
 for Comparing Collaborative- and Content-Based Algorithms for Recommendations\"
 supervised by $andreas_meier and $luis_teran form the $is_group at the $unifr";
  
  $return .= "<h2>Datasets</h2>";
  
  $grouplens = l(
    "GroupLens dataset",
    "http://grouplens.org/datasets/movielens/",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  $movielens = l(
    "MovieLens",
    "https://movielens.org/",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  $book_bx = l(
    "Book-Crossing Dataset",
    "http://www2.informatik.uni-freiburg.de/~cziegler/BX/",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  $stackoverflow = l(
    "Stackexchange data dump",
    "https://archive.org/details/stackexchange",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  
  $return .= "
<ul>
  <li>Movie database: $grouplens from the $movielens project</li>
  <li>Book dataset: $book_bx (c.f. References)</li>
  <li>Stackoverflow dataset: $stackoverflow</li>
</ul>";
  
  $return .= "<a href='#' name='References'>";
  $return .= "<h2>References</h2>";
  $bx_paper = l(
    "Improving Recommendation Lists Through Topic Diversification.",
    "http://www2.informatik.uni-freiburg.de/~dbis/Publications/05/WWW05.html",
    array(
      'attributes' => array('target' => '_blank') 
    )
  );
  $return .= "
<ol>
  <li>$bx_paper<br/>
    Cai-Nicolas Ziegler, Sean M. McNee, Joseph A. Konstan, Georg Lausen; 
    Proceedings of the 14th International World Wide Web Conference (WWW '05), 
    May 10-14, 2005, Chiba, Japan. To appear.
  </li>
  <li>Dietmar Jannach, Markus Zanker, Alexander Felfernig, and Gerhard Friedrich
  . Recommender Systems: An Introduction. Cambridge University Press, 1 edition,
    September 2010.
  </li>
  <li>J Konstan and M Ekstrand. Introduction to recommender systems.
    https://www.coursera.org/course/recsys, 2013 (accessed March 30, 2014).
  </li>
</ol>";
  
  return $return;
}
