<?php

/**
 * Core module for the recommender system workbench
 */
 
/** 
 * Define max user ID as the maximum user ID from the book and movie database. 
 * The logged in user will add it's user id to the max user id constant to get a
 * unique user id in the rating tables
 */ 
define('MAX_USER_ID',278858);
define('MOVIE_DB','Movie_Rating_demo');
define('BOOK_DB','Book_Rating_demo');

// Variables
define('user_id',$GLOBALS['user']->uid + MAX_USER_ID);

// Load the necessary php files
require_once 'util.php';
require_once 'recommendations.php';
require_once 'forms/forms_view.php';
require_once 'forms/forms_submit.php';
require_once 'statistics.php';
require_once 'php-tail/PHPTail.php';

/**
 * Implements hook_menu()
 */
function recsys_wb_menu() {
  $items['myratings'] = array(
    'title' => 'My Ratings', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_myratings',
    'access arguments' => array('access content'),
  );
  $items['myrecommendations'] = array(
    'title' => 'My Recommendations', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_myrecommendations',
    'access arguments' => array('access content'),
  );
  $items['books'] = array(
    'title' => 'Books', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_books',
    'access arguments' => array('access content'),
  );
  $items['movies'] = array(
    'title' => 'Movies', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_movies',
    'access arguments' => array('access content'),
  );
  $items['statistics'] = array(
    'title' => 'Statistics', 
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'recsys_wb_display_stats',
    'access arguments' => array('access content'),
  );
  $items['runrecommender'] = array(
    'title' => 'Run recommender',
    'type' => MENU_CALLBACK,
    'page callback' => 'recsys_wb_run_recommender',
    'access arguments' => array('access content'),  
  );
  $items['tail'] = array(
    'title' => 'Tail',
    'type' => MENU_CALLBACK,
    'page callback' => 'recsys_wb_tail',
    'access arguments' => array('access content'),
  );
  return $items;
}

/**
 * Custom page which displays all the ratings of the currently logged in user
 */
function recsys_wb_myratings() {
  // Prepare the return string
  $return_string = "<h2>Books</h2>";
  
  // Get all the users rating from the database
  $query = db_select(BOOK_DB, 'ratings');
  $query->join(
    'field_data_field_book_id',
    'book_id',
    'ratings.bookid = book_id.field_book_id_value'
  );
  $query->join('node','node','node.nid = book_id.entity_id');
  $query->fields('node',array('title','nid'));
  $query->fields('ratings',array('bookid','userid','rating'));
  $query->condition('ratings.userid',user_id);
  $results = $query->execute();
  
  // Prepeare the tables headers and rows
  $header = array( t('User ID'), t('Book'), t('Rating') );
  $rows = array();
  
  // Check if there are already some ratings
  if( $results->rowCount() == 0 ) {
    $return_string .= "<strong>You haven't rated any books yet</strong></br>";
  }
  else {
    
    // Loop through the results of the DB query and fill in the tables rows
    foreach ($results AS $result)
    {
      $rows[] = array(
        $result->userid,
        l($result->title, 'node/' . $result->nid),
        $result->rating,
      );
    }
    
    // Add the table to the result string
    $return_string .= theme('table', 
                            array('header' => $header, 'rows' => $rows) );
  }
  
  // Add the link to the rating page
  $return_string .= "<p>You can rate books " . l('here','/books') . "</p>";

  // Add the Movie section
  $return_string .= "<h2>Movies</h2>";
  
  // Get all the users rating from the database
  $query = db_select(MOVIE_DB, 'ratings');
  $query->join(
    'field_data_field_movie_id',
    'movie_id',
    'ratings.movieid = movie_id.field_movie_id_value'
  );
  $query->join('node','node','node.nid = movie_id.entity_id');
  $query->fields('node',array('title','nid'));
  $query->fields('ratings',array('movieid','userid','rating'));
  $query->condition('ratings.userid',user_id);
  $results = $query->execute();
  
  // Prepeare the tables headers and rows
  $header = array( t('User ID'), t('Movie'), t('Rating') );
  $rows = array();
  
  // Check if there are already some ratings
  if( $results->rowCount() == 0 ) {
    $return_string .= "<strong>You haven't rated any movies yet</strong></br>";
  }
  else {
    
    // Loop through the results of the DB query and fill in the tables rows
    foreach ($results AS $result)
    {
      $rows[] = array(
        $result->userid,
        l( $result->title, 'node/' . $result->nid),
        $result->rating,
      );
    }
    
    // Add the table to the result string
    $return_string .= theme('table', 
                            array('header' => $header, 'rows' => $rows) );
  }
  
  // Add the link to the rating page
  $return_string .= "<p>You can rate movies " . l('here','/movies') . "</p>";
  
  // Return the HTML string
  return $return_string;
}

/**
 * Custom page which displays all the recommendations of the currently logged
 * in user
 */
function recsys_wb_myrecommendations() {
  // Define the return string variable
  $return_string = drupal_render( drupal_get_form('recsys_wb_get_recommendations_form') );
  
  // Check if the session variable form submitted is set. If yes display the 
  // results, otherwise display the form
  if ( isset( $_SESSION['recommendations_form_submitted'] )
&& $_SESSION['recommendations_form_submitted'] === TRUE ) {
    // Get the recommender app session var
    $recommender_app = $_SESSION['recommender_app'];
    
    // Get the recommender_type_value session var
    $value = $_SESSION['recommender_type_value'];
    
    // Get the recommender app name
    $recommender_app_name = getRecommenderAppName($recommender_app);
    
    // Check which recommender type if is
    if ( $_SESSION['recommender_type'] === 'top n' ) {
      if ( preg_match("/^book/", $recommender_app_name) ) {
        $results = getBookRecommendations('top_n', user_id, $recommender_app, $value );
        $entity = 'Book';
      } else {
        // Get movie recommendations
        $results = getMovieRecommendations('top_n', user_id, $recommender_app, $value );
        $entity = 'Movie';
      }
    } 
    else {
      if ( preg_match("/^book/", $recommender_app_name) ) {
        $results = getBookRecommendations('score', user_id, $recommender_app, $value );
        $entity = 'Book';
      } else {
        // Get movie recommendations
        $results = getMovieRecommendations('score', user_id, $recommender_app, $value );
        $entity = 'Movie';
      }
    }    
  
    if ( sizeof($results) == 0 )
    {
      unset( $_SESSION['recommendations_form_submitted'] );
      return "You have no recommendations yet. Make sure you rate some movies "
             . " and/or books and come back later!";
    }
             
    // Prepare the table headers and rows
    $header = array( $entity, t('Score') );
    $rows = array();
    
    // Loop through the db query results and add each of them to the rows array
    foreach ($results as $result ) {
      $rows[] = $result;
    }
  
    // Assign the renderable array to the return string 
    $return_string .= "<br/>";
    $return_string .= theme('table', array( 'header' => $header, 'rows' => $rows ) );
  }

  // For esthetic reasons unset the form submitted session var, so if a user
  // comes back to "My Recommendations" the page is empty again
  unset( $_SESSION['recommendations_form_submitted'] );

  return $return_string;
}

/**
 * Implements hook_block_info
 */
function recsys_wb_block_info() {
  $blocks['book_rating'] = array(
    'info' => t('Recsys workbench book rating'),
  );
  $blocks['movie_rating'] = array(
    'info' => t('Recsys workbench movie rating'),
  );
  
  return $blocks;
}

/**
 * Implements hook_block_view
 */
function recsys_wb_block_view($delta = '')
{
  $block = array();

  // Get the node
  $node = menu_get_object();

  switch ($delta) {
    case 'book_rating':
      $block['subject'] = t('Rate this book');
      
      // Check if the user has already rated this book, so query the rating for
      // this book from this user
      $book_id = field_get_items("node", $node, "field_book_id");
      $book_id = $book_id[0]["value"];
      $results = db_query("Select * from {" . BOOK_DB . "} where UserID = "
        .":user AND BookID = :book", array(':user' => user_id, ':book' => $book_id) );
      
      if ( $results->rowCount() == 0 ) {
        $block['content'] = drupal_get_form('recsys_wb_book_rating_form');
      }
      else {
        $block['content'] = "You have already rated this book!";
      }

      break;

    case 'movie_rating':
      $block['subject'] = t('Rate this movie');
      
      // Check if the user has already rated this book, so query the rating for
      // this book from this user
      $movie_id = field_get_items("node", $node, "field_movie_id");
      $movie_id = $movie_id[0]["value"];
      $results = db_query("Select * from {" . MOVIE_DB . "} where UserID = "
        .":user AND MovieID = :movie", array(':user' => user_id, ':movie' => $movie_id) );
      
      if ( $results->rowCount() == 0 ) {
        $block['content'] = drupal_get_form('recsys_wb_movie_rating_form');
      }
      else {
        $block['content'] = "You have already rated this movie!";
      }
      
      default:
        break;
  }
    
  return $block;
}

/**
 * Custom page which displays all book of the demo section
 */
function recsys_wb_books() {
  // Get all movies form the database
  $query = db_select('field_data_field_dataset', 'dataset')
    ->extend('PagerDefault')->limit(100);
  $query->join('node', 'node', 'dataset.entity_id = node.nid');
  $query->fields('dataset',array('entity_id'));
  $query->fields('node',array('title'));
  $query->orderBy('node.title');
  $query->condition('dataset.field_dataset_value',99);

  $results = $query->execute();
  
  $header = array( t('Book'));
  $rows = array();
  
  foreach ($results AS $result)
  {
    $rows[] = array(
      l($result->title,'node/' . $result->entity_id)
    );
  }
    

  $output =  theme('table', array('header' => $header, 'rows' => $rows) );
  return $output . theme('pager');
}

/**
 * Custom page which displays all movies of the demo section
 */
function recsys_wb_movies() {
  // Get all movies form the database
  $query = db_select('field_data_field_year', 'year')
    ->extend('PagerDefault')->limit(100);
  $query->join('node', 'node', 'year.entity_id = node.nid');
  $query->fields('year',array('entity_id'));
  $query->fields('node',array('title'));
  $query->orderBy('node.title');
  $query->condition('year.field_year_value',2008);
  $results = $query->execute();
  
  $header = array( t('Node ID'));
  $rows = array();
  
  foreach ($results AS $result)
    {
      $id = $result->entity_id;
      $rows[] = array(
        l($result->title,'node/' . $id)
      );
    }

  $output =  theme('table', array('header' => $header, 'rows' => $rows) );
  return $output . theme('pager');
}

/**
 * Custom page to run recommenders
 */
function recsys_wb_run_recommender() {
  return drupal_get_form('recsys_wb_run_recommender_form');
}

/** 
 * Currently just a test
 */
function recsys_wb_tail() {
  /**
   * Initilize a new instance of PHPTail
   * @var PHPTail
   */
  // Get the UUID of the log file
  $uuid = $_GET['uuid'];
  // Get the log directory
  $log_dir = DRUPAL_ROOT . DIRECTORY_SEPARATOR 
    . drupal_get_path("module","recsys_wb") . DIRECTORY_SEPARATOR . "runs";
  // Get the according file
  $file = $log_dir . DIRECTORY_SEPARATOR . $uuid . ".log";
  // Check if the file exists, if not return some error message
  if ( ! file_exists ( $file ) )
    return "Invalid file: " . $file;
  $tail = new PHPTail($file);
  $tail = $tail->setOrigin(0);

  /**
   * We're getting an AJAX call
   */
  if(isset($_GET['ajax']))  {
    echo $tail->getNewLines($_GET['lastsize'], $_GET['grep'], $_GET['invert']);
    die();
  }
  /**
   * Regular GET/POST call, print out the GUI
   */
  $tail->generateGUI();
}
